/*
 * lora_fz.c
 *
 *  Created on: Jul 15, 2025
 *      Author: liufangzheng
 */

#include "lora_fz.h"

volatile bool RF95_TX_DONE_FLAG  = false;
volatile bool RF95_RX_DONE_FLAG  = false;
volatile bool RF95_CAD_DONE_FLAG = false;

// make sure you defined the LORA_SPI_HANDLE in main.h
extern SPI_HandleTypeDef LORA_SPI_HANDLE;

void LORA_CS_LOW(void) {
  HAL_GPIO_WritePin(LORA_CS_GPIO_Port, LORA_CS_Pin, GPIO_PIN_RESET);
}

void LORA_CS_HIGH(void) {
  HAL_GPIO_WritePin(LORA_CS_GPIO_Port, LORA_CS_Pin, GPIO_PIN_SET);
}

void LORA_RESET_LOW(void) {
  HAL_GPIO_WritePin(LORA_RESET_GPIO_Port, LORA_RESET_Pin, GPIO_PIN_RESET);
}

void LORA_RESET_HIGH(void) {
  HAL_GPIO_WritePin(LORA_RESET_GPIO_Port, LORA_RESET_Pin, GPIO_PIN_SET);
}

uint8_t RF95_ReadReg(uint8_t addr) {
  uint8_t data = 0;
  uint8_t read_address = addr & 0x7F;

  LORA_CS_LOW();
  HAL_SPI_TransmitReceive(&LORA_SPI_HANDLE, &read_address, &data, 1, HAL_MAX_DELAY);
  LORA_CS_HIGH();

  return data;
}

void RF95_WriteReg(uint8_t addr, uint8_t data) {
  uint8_t read_address = addr | 0x80;

  LORA_CS_LOW();
  HAL_SPI_Transmit(&LORA_SPI_HANDLE, &read_address, 1, HAL_MAX_DELAY);
  HAL_SPI_Transmit(&LORA_SPI_HANDLE, &data, 1, HAL_MAX_DELAY);
  LORA_CS_HIGH();
}

void RF95_sleep(void) {
  RF95_WriteReg(REG_OP_MODE, MODE_LONG_RANGE_MODE | MODE_SLEEP);
  HAL_Delay(10); // Allow time for the radio to enter sleep mode
}

void RF95_idle(void) {
  RF95_WriteReg(REG_OP_MODE, MODE_LONG_RANGE_MODE | MODE_STDBY);
}

void RF95_setOCP(uint8_t mA) {
  uint8_t ocpTrim = 27;

  if (mA <= 120) {
    ocpTrim = (mA - 45) / 5;
  }
  else if (mA <=240) {
    ocpTrim = (mA + 30) / 10;
  }

  RF95_WriteReg(REG_OCP, 0x20 | (0x1F & ocpTrim));
}

void RF95_set_freq(unsigned int frequency) {
  // Convert frequency to register value
  uint64_t frf = ((uint64_t)frequency << 19) / 32000000;

  RF95_WriteReg(REG_FRF_MSB, (frf >> 16) & 0xFF);
  RF95_WriteReg(REG_FRF_MID, (frf >> 8) & 0xFF);
  RF95_WriteReg(REG_FRF_LSB, frf & 0xFF);
}

void RF95_setBW(int BW) {
  uint8_t config = RF95_ReadReg(REG_MODEM_CONFIG_1);

  switch (BW) {
    case 125: // 125 kHz
      config = (config & 0x0F) | 0x70;
      break;
    case 250: // 250 kHz
      config = (config & 0x0F) | 0x80;
      break;
    case 500: // 500 kHz
      config = (config & 0x0F) | 0x90;
      break;
  }

  RF95_WriteReg(REG_MODEM_CONFIG_1, config);
}

void RF95_setTxPower(int power, int outputPin) {
  if (outputPin == PA_OUTPUT_RFO_PIN) {
    if (power < 0) {
      power = 0;
    }
    else if (power > 14) {
      power = 14;
    }

    RF95_WriteReg(REG_PA_CONFIG, 0x70 | power);
  }
  else {
    if (power > 17) {
      if (power > 20) {
        power = 20;
      }

      // subtract 3 from level, so 18 - 20 maps to 15 - 17
      power -= 3;

      // High Power +20 dBm Operation (Semtech SX1276/77/78/79 5.4.3.)
      RF95_WriteReg(REG_PA_DAC, 0x87);
      RF95_setOCP(140);
    }
    else {
      if (power < 2) {
        power = 2;
      }
      //Default value PA_HF/LF or +17dBm
      RF95_WriteReg(REG_PA_DAC, 0x84);
      RF95_setOCP(100);
    }

    RF95_WriteReg(REG_PA_CONFIG, PA_BOOST | (power - 2));
  }
}

void RF95_reset(void) {
  LORA_RESET_LOW();
  HAL_Delay(10); // Hold reset for 10 ms
  LORA_RESET_HIGH();
  HAL_Delay(10); // Allow time for the radio to reset
}

int RF95_Init(Role role, unsigned int frequency, unsigned int BW, int power) {
  RF95_reset();

  // set SPI speed
  LORA_SPI_HANDLE.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_32; // Adjust as needed
  if (HAL_SPI_Init(&hspi1) != HAL_OK) {
    Error_Handler();
  }

  uint8_t version = RF95_ReadReg(REG_VERSION);
  if (version != 0x12) {
    return 0;
  }

  RF95_sleep();
  RF95_set_freq(frequency);

  // set base addresses
  RF95_WriteReg(REG_FIFO_TX_BASE_ADDR, 0);
  RF95_WriteReg(REG_FIFO_RX_BASE_ADDR, 0);

  // set LNA boost
  RF95_WriteReg(REG_LNA, RF95_ReadReg(REG_LNA) | 0x03);

  // set auto AGC
  RF95_WriteReg(REG_MODEM_CONFIG_3, 0x04);

  // set bandwidth to 500kHz
  RF95_setBW(BW);

  // set output power to 17 dBm
  RF95_setTxPower(power, PA_OUTPUT_PA_BOOST_PIN);

  // put in standby mode
  RF95_idle();

  return 1;
}


void RF95_SetTxDoneFlag(void) {
  RF95_TX_DONE_FLAG = true;
}
void RF95_SetRxDoneFlag(void) {
  RF95_RX_DONE_FLAG = true;
}
void RF95_SetCadDoneFlag(void) {
  RF95_CAD_DONE_FLAG = true;
}

