/*
 * microsd_fz.c
 *
 *  Created on: Jul 25, 2025
 *      Author: liufangzheng
 */


#include "microsd_fz.h"

extern SPI_HandleTypeDef SD_SPI_HANDLE;

FATFS   FatFs; //Fatfs handle
FIL     fil;   //File handle
FRESULT fres;  //Result after operations

FRESULT mount_sd_card(void) {
  // Mount the SD card
  return f_mount(&FatFs, "", 1);
}

/**
 * @brief Get the statistics of the SD card.
 * 
 * @param free_clusters 
 * @param free_sectors 
 * @param total_sectors 
 */
void get_statistics (
  DWORD *free_clusters,
  DWORD *free_sectors, 
  DWORD *total_sectors
) {
  FATFS* getFreeFs;
  FRESULT fres = f_getfree("", &free_clusters, &getFreeFs);
  *total_sectors = (getFreeFs->n_fatent - 2) * getFreeFs->csize; // Total sectors = total clusters - reserved clusters
  *free_sectors = *free_clusters * getFreeFs->csize; // Free
}

FRESULT close_file(void) {
  f_close(&fil); // Close the file after reading
}

/**
 * @brief Open a file and create a file if it does not exist.
 * 
 * @param filename 
 * @param buffer 
 * @param buffer_size 
 * @return FRESULT 
 */
FRESULT open_file (
  const char *filename,
  char *buffer,
  size_t buffer_size
) {
  // Open the file for reading
  fres = f_open(&fil, filename, FA_READ | FA_OPEN_EXISTING);
  // FA_CREATE_ALWAYS is used to create a new file, overwriting any existing file with the same name.
  // FA_CREATE_NEW is used to create a new file, but it will fail if the file already exists.
  if (fres != FR_OK) { // If the file does not exist, create it
    fres = f_open(&fil, filename, FA_WRITE | FA_CREATE_ALWAYS);
    if (fres != FR_OK) {
      return fres; // Return error if file creation fails
    }
  }

  return FR_OK; // Return success
}

FRESULT write_file (
  const char *filename,
  const char *data
) {
  ;
}

FRESULT write_data_to_file (
  const char *filename,
  const char *data
) {
  ;
}
